<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>訂餐與住宿統計表</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">

  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #dddddd;
      text-align: center;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <div id="menu-bar"></div>

  <div class="container mt-4">
    <h1>訂餐與住宿統計表</h1>

    <!-- 日期選擇器 -->
    <div class="form-group">
      <label for="datepicker">選擇日期:</label>
      <input type="text" id="datepicker" class="form-control" placeholder="選擇日期範圍">
    </div>
    <button id="generateTableBtn" class="btn btn-primary">生成表格</button>

    <!-- 容納表格 -->
    <div id="tables-container">
      <!-- Table will be populated by JavaScript -->
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/locales/bootstrap-datepicker.zh-TW.min.js"></script>

  <script>
    // 日期選擇器設置
    $('#datepicker').datepicker({
      format: 'yyyy-mm-dd',
      language: 'zh-TW',
      multidate: true,
      multidateSeparator: ',',
      todayHighlight: true
    });

    // 預設行數據
    const defaultRowsData = [
      { title: '受訓-新進人員', values: [] },
      { title: '受訓-新進人員(線上)', values: [] },
      { title: '受訓-業務人員(旁聽)', values: [] },
      { title: '住宿 -', values: [] },
      { title: '行銷+行政(含珊珊)', values: [] },
      { title: '受邀講師', values: [] },
      { title: '不在人員(請填上姓名及特殊備註)', values: [] }
    ];

    // 生成表格
    document.getElementById('generateTableBtn').addEventListener('click', function() {
      const selectedDates = $('#datepicker').datepicker('getDates').map(formatDate);
      const tablesContainer = document.getElementById('tables-container');
      tablesContainer.innerHTML = ''; // 清空之前的表格

      addTable(selectedDates);
    });

    // 格式化日期為 yyyy-mm-dd
    function formatDate(date) {
      const d = new Date(date);
      const month = '' + (d.getMonth() + 1);
      const day = '' + d.getDate();
      const year = d.getFullYear();

      return [year, (month.length < 2 ? '0' : '') + month, (day.length < 2 ? '0' : '') + day].join('-');
    }

    // 添加新的表格
    function addTable(dates) {
      const tablesContainer = document.getElementById('tables-container');
      const tableElement = document.createElement('div');
      tableElement.classList.add('table-wrapper');

      tableElement.innerHTML = createTableHTML(defaultRowsData, dates);
      tablesContainer.appendChild(tableElement);

      // 計算新表格的總數
      tableElement.querySelectorAll('select').forEach(select => calculateTotal(select));
    }

    // 創建表格 HTML 字符串
    function createTableHTML(rowsData, dates) {
      return `
        <table>
          <thead>
            <tr>
              <th> </th>
              ${dates.map(date => `
                <th>
                  <input type="text" value="${date}" class="form-control" placeholder="月/日" style="width: 100px;" readonly>
                </th>
              `).join('')}
            </tr>
          </thead>
          <tbody>
            ${rowsData.map(rowData => `
              <tr>
                <td>${rowData.title}</td>
                ${dates.map(date => `
                  <td>
                    ${generateSelect(0)}
                  </td>
                `).join('')}
              </tr>
            `).join('')}
            <tr>
              <td><strong>total 人數</strong></td>
              ${dates.map(() => '<td><strong>0</strong></td>').join('')}
            </tr>
            <tr>
              <td><strong>Location</strong></td>
              ${dates.map(() => `<td>${generateCitySelect()}</td>`).join('')}
            </tr>
          </tbody>
        </table>
      `;
    }

    // 生成 <select> 元素
    function generateSelect(selected = 0) {
      let select = '<select class="form-control" onchange="calculateTotal(this)">';
      for (let i = 0; i <= 10; i++) {
        select += `<option value="${i}" ${i === selected ? 'selected' : ''}>${i}</option>`;
      }
      select += '</select>';
      return select;
    }

    // 生成城市選擇 <select> 元素
    function generateCitySelect() {
      const cities = ['台北', '台中', '高雄'];
      let select = '<select class="form-control">';
      cities.forEach(city => {
        select += `<option value="${city}">${city}</option>`;
      });
      select += '</select>';
      return select;
    }

    // 計算每一列的總數
    function calculateTotal(selectElement) {
      const table = selectElement.closest('table');
      const tbody = table.querySelector('tbody');
      const totalRow = tbody.querySelector('tr:nth-last-of-type(2)');

      const colIndex = Array.from(selectElement.closest('tr').children).indexOf(selectElement.closest('td'));
      let total = 0;
      tbody.querySelectorAll('tr:not(:nth-last-of-type(2)):not(:nth-last-of-type(1))').forEach(row => {
        const select = row.children[colIndex].querySelector('select');
        total += parseInt(select.value) || 0;
      });
      totalRow.children[colIndex].innerText = total;
    }
  </script>
  <script>
    // JavaScript to dynamically load menu bar
    fetch('menu.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('menu-bar').innerHTML = data;
      })
      .catch(error => console.error('Error loading menu:', error));
  </script>
</body>
</html>
